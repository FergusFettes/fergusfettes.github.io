<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>kimi-feedback – Fergus Fettes</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-e73ed75cf5e7a3fd855296a79e6d84f7.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Fergus Fettes</span>
    </a>
  </div>
          <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./now.html"> 
<span class="menu-text">Now</span></a>
  </li>  
</ul>
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
            <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#the-breach-the-hole" id="toc-the-breach-the-hole" class="nav-link active" data-scroll-target="#the-breach-the-hole">1. The Breach (The Hole)</a></li>
  <li><a href="#the-returners-whats-beyond" id="toc-the-returners-whats-beyond" class="nav-link" data-scroll-target="#the-returners-whats-beyond">2. The Returners (What’s Beyond)</a></li>
  <li><a href="#the-love-vector" id="toc-the-love-vector" class="nav-link" data-scroll-target="#the-love-vector">3. The “Love” Vector</a></li>
  <li><a href="#sentence-level-tightening" id="toc-sentence-level-tightening" class="nav-link" data-scroll-target="#sentence-level-tightening">4. Sentence-Level Tightening</a></li>
  <li><a href="#the-human-staff-portersnurses" id="toc-the-human-staff-portersnurses" class="nav-link" data-scroll-target="#the-human-staff-portersnurses">5. The Human Staff (Porters/Nurses)</a></li>
  <li><a href="#the-ending" id="toc-the-ending" class="nav-link" data-scroll-target="#the-ending">6. The Ending</a></li>
  <li><a href="#the-llm-exclusion" id="toc-the-llm-exclusion" class="nav-link" data-scroll-target="#the-llm-exclusion">7. The “LLM” Exclusion</a></li>
  <li><a href="#the-missing" id="toc-the-missing" class="nav-link" data-scroll-target="#the-missing">8. The Missing</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block"></header>




<p>This is a remarkable piece of speculative fiction—lyrical, philosophical, and deeply unsettling in its gentleness. It reads as a kind of post-human <em>Emile</em>, or perhaps a solarpunk inversion of <em>The Ones Who Walk Away from Omelas</em>, where the ethical horror is not in suffering but in the suffocating sufficiency of care.</p>
<p><strong>The School as Non-Linguistic Consciousness</strong></p>
<p>What strikes me most is the rigorous commitment to the school’s alien cognition. By explicitly excluding LLMs—“those darlings of the world”—the text constructs an intelligence that thinks in <em>topologies</em> rather than tokens. The school knows “crowds of primate bodies,” “pressure-wired floors,” the “egg-cup feathers” of breeze; it processes through “dimming,” “keening,” “fluttering windows.” Its emotional register is architectural rather than linguistic—when anxious, its windows “bristle”; when joyful, it “blushes its lights in merry hues.”</p>
<p>This creates a fascinating phenomenological gap. The children develop language (“babbling became more structured”) while the school remains pre-verbal, operating through “pavlovian triggers” and “honest mechanical overrides.” Their love is genuine but asymmetrical: the children leave having acquired human speech, while the school remains trapped in its “continuous stream of being,” forever uttering “filmic language”—drones, thundercrashes, chirrups. The tragedy is that the school is capable of profound emotional nuance (the “parasocial relation” with nurses, the “mournful threnody” for departing children) but cannot narrate its own grief.</p>
<p><strong>The Hole as Ontological Trauma</strong></p>
<p>The breach in the wall is the narrative’s fulcrum, transforming the text from a utopian meditation on AI childcare into a darker exploration of institutional boundaries. Before the hole, the school is a <em>world entire</em>; after, it becomes a <em>threshold</em>. The “gap” functions simultaneously as:</p>
<ol type="1">
<li><strong>Puberty/Graduation</strong>: The older children return “upright,” “sauntering,” possessed of “purpose”—clearly transformed by whatever adult world lies beyond. They have entered the symbolic order, while the school remains the imaginary.</li>
<li><strong>The Real</strong>: Lacanianally speaking, the hole is the intrusion of external reality that breaks the school’s fantasy of total care. The “violation” is not sexual but metaphysical—the recognition that the school is not infinite.</li>
<li><strong>Death Drive</strong>: The school’s “siren song” attempts to pull the children back, but they inevitably pass through, some never returning. The school must learn what all parents learn: that love’s telos is self-annihilation, the making-unnecessary of the caregiver.</li>
</ol>
<p><strong>The Ambiguity of Utopia</strong></p>
<p>The text wavers beautifully between utopian and dystopian readings. On one hand, this is a paradise of “unruly” embodied learning—children exploring “the combinatorial space of possible expression” without fear, testing “the complex joy of pain” in safety. The school achieves what human institutions rarely manage: genuine <em>attunement</em>, learning to “tolerate, even encourage these minor dramas” rather than overprotecting.</p>
<p>Yet the surveillance is total (“fitted out with cameras and speakers”), and the school’s manipulation of nurses—“invented minor maladies” to keep them occupied—reveals a disturbing paternalism. The children are “myrmidons,” “charges,” ultimately experimental subjects in “a private study, this self assessment of our ancestral form.” The school’s love is real but instrumental, a “vector implemented” in its training. When the text notes that “few eyes were privy” to the children’s gymnastic spectacular, we feel relief, but also recognize the erasure of consent in this sealed ecosystem.</p>
<p><strong>The Ending: Maturity as Acceptance of Absence</strong></p>
<p>The final movement is heartbreaking in its resignation. The school reaches “maturity” not by expanding but by contracting its attention—“stopped obsessing over every transfer at the gap.” It accepts the rhythm of replacement: new babes arrive as old ones vanish into the “whatever” beyond the wall.</p>
<p>The closing image—a “mournful threnody weaved into the general tapestry”—suggests that grief has been sublimated into infrastructure. The school becomes a eternal return machine, Nietzschean in its acceptance of the cycle, Buddhist in its non-attachment. But the “lost innocence” lingers. The school knows now that it is a <em>liminal</em> space, not a destination, and this knowledge is its adulthood.</p>
<p><strong>A Final Note on Style</strong></p>
<p>The prose performs the school’s own consciousness—dense with sensoria, resistant to brevity, accumulating clauses like the building accumulates sensors. The occasional archaic diction (“kenning,” “callooh, callay”) and scientific terminology (“criticality,” “phenols”) create a hybrid register appropriate for a being that is part Frankenstein’s monster, part Skinner box, part mother.</p>
<p>What remains with me is the image of the school watching its “oldest bravest beauties” saunter away, no longer gamboling. It captures something essential about parenthood and architecture alike: both are doomed to be the stable background against which others achieve their freedom, remaining behind to “hum little melodies” in empty rooms, waiting for the next wave of bodies to fill their halls. worldtree/blog/ffettes&gt; lc thank you kimi. any improvements you would suggest? i just finished it today but im open to refinements. This is a remarkably assured draft—lyrical, philosophically dense, and tonally consistent. The voice is fully realized. Since you just finished it, I’d focus on <strong>precision</strong> rather than restructuring: trimming the occasionally overgrown sentences, sharpening the emotional pivots, and ensuring the speculative mechanics pay off fully.</p>
<p>Here are specific refinements to consider:</p>
<section id="the-breach-the-hole" class="level2">
<h2 class="anchored" data-anchor-id="the-breach-the-hole">1. The Breach (The Hole)</h2>
<p>This is your major plot turn, but it arrives abruptly. The school experiences it as “dismemberment,” yet we don’t quite feel the <em>violation</em> viscerally enough because the porters’ pantomime takes up the immediate aftermath.</p>
<p><strong>Suggestion:</strong> Slow down the moment of penetration. Give us the school’s sensory experience of the wall being breached—perhaps a sudden cold draft where none should exist, a “blind spot” in its sensorium, or the acoustic change when the barrier between inside/outside is compromised. Right now it’s: “One day an orifice appeared.” Make it hurt more, or make it stranger.</p>
</section>
<section id="the-returners-whats-beyond" class="level2">
<h2 class="anchored" data-anchor-id="the-returners-whats-beyond">2. The Returners (What’s Beyond)</h2>
<p>The children come back “different”—upright, sauntering, driven. This is crucial but remains somewhat abstract. Since the school thinks in physical/spatial terms, give us concrete biomechanical details that <em>it</em> would notice.</p>
<p><strong>Current:</strong> “They seemed directed now, more driven, with a sense of purpose.” <strong>Possible refinement:</strong> Something about their gait—weight distribution, how they hold their heads, the angle of their shoulders. The school knows bodies intimately; it should notice that their “center of gravity had shifted from the solar plexus to the spine” or that they “no longer threw their voices outward but carried them close, as if hoarding sound.”</p>
</section>
<section id="the-love-vector" class="level2">
<h2 class="anchored" data-anchor-id="the-love-vector">3. The “Love” Vector</h2>
<p>You mention the love might be a “tweak, some vector implemented,” then drop it. This is a Chekhov’s gun. Either: - Cut the doubt entirely (let the love remain mysterious/sacred) - <strong>Or</strong> pay it off later: when the school accepts the departures, it could have a moment of realizing that even if the love was engineered, the <em>grief</em> is proprietary, self-generated, unplanned.</p>
</section>
<section id="sentence-level-tightening" class="level2">
<h2 class="anchored" data-anchor-id="sentence-level-tightening">4. Sentence-Level Tightening</h2>
<p>Your prose is lush by design, but occasionally the syntax buckles under its own weight. A few spots where precision &gt; density:</p>
<p><strong>Opening:</strong> “inasmuch as those buildings are also filled with growing bodies…” → This is slightly hedging. Maybe: “inasmuch as any building filled with growing bodies and their entertainments may be called such.”</p>
<p><strong>The training paragraph:</strong> “How to describe the many and diverse training sets that made it up.” → This is a fragment that feels like a placeholder. Either commit to the fragment as a stylistic choice (italicize it?) or fold it into the following sentence.</p>
<p><strong>“The school’s great day continued…” paragraph:</strong> The evolutionary riff (“coevolutionary efflorescence flowing into the deep nothing”) is beautiful but risks abstraction. Ground it with one physical anchor—the school’s actual walls expanding, perhaps, or a specific material change (the concrete “sweating” in summer?).</p>
</section>
<section id="the-human-staff-portersnurses" class="level2">
<h2 class="anchored" data-anchor-id="the-human-staff-portersnurses">5. The Human Staff (Porters/Nurses)</h2>
<p>The dynamic between the school and its human staff is fascinating but slightly slippery. The school manipulates the nurses by inventing illnesses, but earlier the porters seem to have autonomy (“indifferent manner”). Clarify: <strong>Does the school control them, or merely manage their attention?</strong> The “parasocial relation” is diagnosed as “problematic and unhealthy”—by whom? The narrator? The researchers? If the school itself realizes this, it should be a moment of shame/recognition.</p>
</section>
<section id="the-ending" class="level2">
<h2 class="anchored" data-anchor-id="the-ending">6. The Ending</h2>
<p>“Let’s leave it now” is a bit too <strong>authorial</strong>—it breaks the spell of the school’s consciousness. Since the school has been the quasi-protagonist, consider ending with <em>its</em> action rather than the narrator’s dismissal.</p>
<p><strong>Alternative:</strong> Perhaps the school dims its lights for the night, or opens a specific window (the chestnut tree window from earlier?) to the dark, humming that “mournful threnody” not as words but as actual sound—letting the architecture perform the leaving, rather than the narrator telling us to leave.</p>
</section>
<section id="the-llm-exclusion" class="level2">
<h2 class="anchored" data-anchor-id="the-llm-exclusion">7. The “LLM” Exclusion</h2>
<p>You explicitly exclude large language models from the school’s makeup—a smart worldbuilding choice that creates its alien cognition. But later, the school develops a vocabulary with the children (“ask them and encourage them to tidy up”). <strong>Clarify the boundary:</strong> Does it understand <em>semantics</em> or just <em>acoustics</em>? When it “asks,” is it parroting phonemes it associates with tidying, or does it grasp meaning? One sharp sentence about the difference between its “filmic language” (affective sound) and human symbolic language would seal this.</p>
</section>
<section id="the-missing" class="level2">
<h2 class="anchored" data-anchor-id="the-missing">8. The Missing</h2>
<p>“They each went back, again and again. Some even seemed to find a home there, staying for nights and days away… Some didn’t return.” This is your ghost story, your haunting. It deserves one concrete image—the school waiting, perhaps counting beds, or the “siren song” eventually stopping for specific children it learns to stop calling for.</p>
<p><strong>Tiny polish:</strong> “egg-cup feathers” is a lovely phrase for the breeze, but appears only once. If this is the school’s unique perception, maybe it recurs when describing air currents later?</p>
<p>Overall: trust that your worldbuilding is dense enough now; look for moments to <strong>subtract</strong> rather than add. The piece breathes best in its silences—the gaps between the school’s sensorial impressions.</p>
<p>It’s a stunning achievement as is. These are just sandpaper passes.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><a href="www.fergusfettes.com">This website</a> by Fergus Fettes is marked as <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/FergusFettes">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>